version: 2

models:
  - name: cu4_zone_store_share_shifts
    description: >
      CU4 · Cambios de cuota de visitas entre tiendas dentro de cada zona de origen.
      Usa fct_mobility_od_day para calcular el share de cada tienda destino
      dentro del total de llegadas de una origin_zone_id y su variación (delta_share) vs el día anterior.
    columns:
      - name: origin_zone_id
        description: "Origin zone of the flow (natural key from zones staging)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__zones')
                field: zone_id

      - name: origin_zone_name
        description: "Name of the origin zone."

      - name: dest_store_id
        description: "Destination store (FK to dim_store)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_store')
                field: store_id

      - name: dest_store_name
        description: "Destination store name, from dim_store."

      - name: date_id
        description: "Business date (FK to dim_date)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

      - name: share_in_zone
        description: "Share of arrivals for dest_store within (origin_zone_id, date_id)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between 0 and 1"

      - name: prior_share_in_zone
        description: "Share_in_zone for the previous date for the same (origin_zone_id, dest_store_id)."

      - name: delta_share
        description: "share_in_zone - prior_share_in_zone (positive: gana cuota; negativo: pierde)."

  - name: cu5_store_operational_pressure
    description: >
      CU5 · Hotspots de presión operativa por tienda.
      Agrega fct_store_traffic_day para calcular medias históricas de presión,
      utilización, colas, esperas y entradas.
    columns:
      - name: store_id
        description: "Store natural key (from dim_store)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_store')
                field: store_id

      - name: store_name
        description: "Store name from dim_store."

      - name: zone_id
        description: "Denormalized zone of the store."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__zones')
                field: zone_id

      - name: region_id
        description: "Denormalized region of the store."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__regions')
                field: region_id

      - name: country_id
        description: "Denormalized country of the store."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__countries')
                field: country_id

      - name: avg_pressure_index
        description: "Average pressure_index_5m across all days for the store."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: avg_utilization
        description: "Average utilization across all days for the store."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: avg_queue
        description: "Average queue length across all days."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: avg_wait_seconds
        description: "Average waiting time (seconds) across all days."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: avg_daily_entries
        description: "Average daily people_in_count for the store."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

  - name: cu6_weather_effect_on_distance
    description: >
      CU6 · Efecto del clima en la distancia recorrida hasta la tienda.
      Clasifica flujos en NEAR / MID / FAR según distance_km
      y calcula la distribución de arrivals por weather_bucket.
    columns:
      - name: weather_bucket
        description: "Weather bucket (MILD / HOT / COLD / LIGHT_RAIN / HEAVY_RAIN)."
        tests:
          - not_null

      - name: distance_bucket
        description: "Distance bucket: NEAR (<5km) / MID (5–15km) / FAR (>=15km)."
        tests:
          - not_null

      - name: arrivals
        description: "Total arrivals for (weather_bucket, distance_bucket)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: total_arrivals
        description: "Total arrivals for that weather_bucket (suma sobre todos los distance_bucket)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: share_of_arrivals
        description: "arrivals / total_arrivals for that (weather_bucket, distance_bucket)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between 0 and 1"
