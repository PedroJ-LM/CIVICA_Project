version: 2

models:

  # ======================
  # DIMENSIONES
  # ======================

  - name: dim_date
    description: "Date dimension built with dbt_date (one row per calendar day)."
    columns:
      - name: date_id
        description: "Primary key of the date dimension (DATE)."
        tests:
          - not_null
          - unique

      - name: year
      - name: month
      - name: day_of_month
      - name: day_of_week
      - name: is_weekend

  - name: dim_store
    description: "Store dimension with FK to zone, plus format, status and capacity."
    columns:
      - name: store_id
        description: "Store natural key."
        tests:
          - not_null
          - unique

      - name: store_name
        description: "Canonical store name."

      - name: zone_id
        description: "Zone of the store (FK to dim_zone)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_zone')
                field: zone_id

      - name: store_format_id
        description: "FK to stg_franchise_script__store_formats."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__store_formats')
                field: store_format_id

      - name: store_format_name
        description: "Human-readable store format (e.g. HYPERMARKET, CONVENIENCE...)."

      - name: store_status_id
        description: "FK to stg_franchise_script__store_status."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__store_status')
                field: store_status_id

      - name: store_status_name
        description: "Human-readable store status (e.g. OPEN, CLOSED, UNDER_RENOVATION...)."

      - name: capacity_per_hour
        description: "Operational throughput capacity; must be >= 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: floor_area_m2
        description: "Store floor area in square meters; must be >= 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: gate_count
        description: "Number of gates; must be >= 1."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 1"

      - name: lat
        description: "Store latitude."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between -90 and 90"

      - name: lon
        description: "Store longitude."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between -180 and 180"

      - name: date_load_utc
        description: "Last load date in UTC for this record."


  - name: dim_zone
    description: "Geographic dimension at zone grain, including region, country and currency."
    columns:
      - name: zone_id
        description: "Zone natural key."
        tests:
          - not_null
          - unique

      - name: zone_name
        description: "Canonical zone name."

      - name: zone_lat
        description: "Zone centroid latitude."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between -90 and 90"

      - name: zone_lon
        description: "Zone centroid longitude."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between -180 and 180"

      - name: population
        description: "Population of the zone; must be >= 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: income_index
        description: "Relative income index for the zone; must be >= 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: unemployment_rate_pct
        description: "Unemployment rate in percentage; must be between 0 and 100."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between 0 and 100"

      - name: region_id
        description: "Region of the zone."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__regions')
                field: region_id

      - name: region_name
        description: "Region name of the zone."

      - name: country_id
        description: "Country of the zone."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__countries')
                field: country_id

      - name: country_name
        description: "Country name of the zone."

      - name: currency_code
        description: "ISO currency code for the zone's country (EUR, USD, etc.)."

      - name: currency_name
        description: "Currency name for the zone's country (Euro, US Dollar, etc.)."

  # ======================
  # HECHOS
  # ======================

  - name: fct_store_sales_day
    description: "Daily sales per store, enriched with store zone and weather context."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id', 'date_id']
    columns:
      - name: store_id
        description: "FK to dim_store."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_store')
                field: store_id

      - name: date_id
        description: "FK to dim_date."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

      - name: zone_id
        description: "Zone of the store (denormalized from dim_store/dim_zone)."
        tests:
          - relationships:
              arguments:
                to: ref('dim_zone')
                field: zone_id

      - name: region_id
        description: "Region of the store (derived from dim_zone)."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__regions')
                field: region_id

      - name: country_id
        description: "Country of the store (derived from dim_zone)."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__countries')
                field: country_id

      - name: tickets_day
        description: "Number of tickets in the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: gross_amount_day
        description: "Total sales amount in the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: avg_ticket
        description: "Average ticket amount in the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: t_avg_c
        description: "Average temperature in the store zone for that day."

      - name: rain_mm
        description: "Precipitation in mm."

      - name: wind_kmh
        description: "Wind speed."

      - name: weather_label_id
        description: "FK to stg_franchise_script__weather_labels."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__weather_labels')
                field: weather_label_id

      - name: weather_bucket
        description: "Discrete bucket derived from temp and rainfall (MILD, HOT, COLD, LIGHT_RAIN, HEAVY_RAIN)."

      - name: is_rainy
        description: "1 if rain_mm >= 1, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"

      - name: is_hot
        description: "1 if t_avg_c >= 28, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"

      - name: is_cold
        description: "1 if t_avg_c <= 5, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"


  - name: fct_store_traffic_day
    description: "Daily traffic per store (entries, queues, devices, capacity and pressure index)."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id', 'date_id']
    columns:
      - name: store_id
        description: "FK to dim_store."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_store')
                field: store_id

      - name: date_id
        description: "FK to dim_date."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

      - name: zone_id
        description: "Zone of the store (denormalized from dim_store/dim_zone)."
        tests:
          - relationships:
              arguments:
                to: ref('dim_zone')
                field: zone_id

      - name: region_id
        description: "Region of the store (derived from dim_zone)."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__regions')
                field: region_id

      - name: country_id
        description: "Country of the store (derived from dim_zone)."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__countries')
                field: country_id

      - name: people_in_count
        description: "Total inbound people in the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: people_out_count
        description: "Total outbound people in the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: queue_avg
        description: "Average queue length during the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: wait_avg_s
        description: "Average waiting time in seconds during the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: devices
        description: "Average number of detected devices in the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: capacity_per_hour
        description: "Nominal store capacity per hour (from dim_store)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: arrival_rate_ph
        description: "People_in_count converted to an hourly rate using the arrival_rate_per_hour macro."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: utilization_5m
        description: "Utilization ratio (arrival_rate_ph / capacity_per_hour)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: pressure_index_5m
        description: "Composite pressure index based on utilization and queue length."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"


  - name: fct_mobility_od_day
    description: "Daily mobility flows from origin zones to destination stores, with gravity score and weather context."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['origin_zone_id', 'dest_store_id', 'date_id']
    columns:
      - name: origin_zone_id
        description: "Origin zone of the flow (FK to dim_zone)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_zone')
                field: zone_id

      - name: dest_store_id
        description: "FK to dim_store (destination store)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_store')
                field: store_id

      - name: date_id
        description: "FK to dim_date (day of the flow)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

      - name: arrivals
        description: "Total arrivals from origin_zone to dest_store in that day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: distance_km
        description: "Distance between zone centroid and store in km."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: gravity_score
        description: "Gravity-model potential for that OD pair on that day."

      - name: origin_population
        description: "Population of the origin zone (from dim_zone)."

      - name: dest_floor_area_m2
        description: "Floor area of the destination store in m2."

      - name: dest_capacity_per_hour
        description: "Operational throughput capacity of the destination store."

      - name: weather_bucket
        description: "Weather category for the origin zone on that day (MILD / HOT / COLD / LIGHT_RAIN / HEAVY_RAIN)."

      - name: is_rainy
        description: "1 if it is a rainy day in the origin zone, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"

      - name: is_hot
        description: "1 if it is a hot day in the origin zone, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"

      - name: is_cold
        description: "1 if it is a cold day in the origin zone, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"
