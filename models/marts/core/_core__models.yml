version: 2

models:

  # ======================
  # DIMENSIONES
  # ======================

  - name: dim_date
    description: "Date dimension built with dbt_date (one row per calendar day)."
    columns:
      - name: date_id
        description: "Primary key of the date dimension (DATE)."
        tests: [not_null, unique]

      - name: year
      - name: month
      - name: day_of_month
      - name: day_of_week
      - name: is_weekend

  - name: dim_store
    description: "Denormalized store dimension with zone, region, country, format, status and capacity."
    columns:
      - name: store_id
        description: "Store natural key."
        tests: [not_null, unique]

      - name: store_name
        description: "Canonical store name."

      - name: zone_id
        description: "Zone of the store (natural key from zones staging)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__zones')
                field: zone_id

      - name: region_id
        description: "Region of the store."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__regions')
                field: region_id

      - name: country_id
        description: "Country of the store."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__countries')
                field: country_id

      - name: store_format_id
        description: "FK to stg_franchise_script__store_formats."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__store_formats')
                field: store_format_id

      - name: store_status_id
        description: "FK to stg_franchise_script__store_status."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__store_status')
                field: store_status_id

      - name: capacity_per_hour
        description: "Operational throughput capacity; must be >= 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: floor_area_m2
        description: "Store floor area in square meters; must be >= 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: gate_count
        description: "Number of gates; must be >= 1."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 1"

      - name: lat
        description: "Store latitude."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between -90 and 90"

      - name: lon
        description: "Store longitude."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between -180 and 180"


  # ======================
  # HECHOS
  # ======================

  - name: fct_store_sales_day
    description: "Daily sales per store, enriched with store zone and weather context."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id', 'date_id']
    columns:
      - name: store_id
        description: "FK to dim_store."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_store')
                field: store_id

      - name: date_id
        description: "FK to dim_date."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

      - name: zone_id
        description: "Zone of the store (denormalized from dim_store)."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__zones')
                field: zone_id

      - name: tickets_day
        description: "Number of tickets in the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: gross_amount_day
        description: "Total sales amount in the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: avg_ticket
        description: "Average ticket amount in the day."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: t_avg_c
        description: "Average temperature in the store zone for that day."

      - name: rain_mm
        description: "Precipitation in mm."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: wind_kmh
        description: "Wind speed."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: weather_label_id
        description: "FK to stg_franchise_script__weather_labels."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__weather_labels')
                field: weather_label_id

      - name: weather_bucket
        description: "Discrete bucket derived from temp and rainfall (MILD, HOT, COLD, LIGHT_RAIN, HEAVY_RAIN)."

      - name: is_rainy
        description: "1 if rain_mm >= 1, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"

      - name: is_hot
        description: "1 if t_avg_c >= 28, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"

      - name: is_cold
        description: "1 if t_avg_c <= 5, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"


  - name: fct_store_traffic_5m
    description: "5-minute traffic per store (entries, queues, devices, capacity and pressure index)."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id', 'date_id', 'minute_5m_index']
    columns:
      - name: store_id
        description: "FK to dim_store."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_store')
                field: store_id

      - name: date_id
        description: "FK to dim_date (cast of ts_5m)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

      - name: minute_5m_index
        description: "Index of the 5-minute slot in the day (0â€“287)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between 0 and 287"

      - name: zone_id
        description: "Zone of the store (denormalized from dim_store)."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__zones')
                field: zone_id

      - name: region_id
        description: "Region of the store (denormalized from dim_store)."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__regions')
                field: region_id

      - name: country_id
        description: "Country of the store (denormalized from dim_store)."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__countries')
                field: country_id

      - name: people_in_count
        description: "People entering through all gates in that 5-minute slot."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: people_out_count
        description: "People exiting through all gates in that 5-minute slot."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: queue_avg
        description: "Average queue length in that 5-minute slot."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: wait_avg_s
        description: "Average waiting time in seconds in that 5-minute slot."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: devices
        description: "Average number of detected devices in that 5-minute slot."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: capacity_per_hour
        description: "Nominal store capacity per hour (from dim_store)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: arrival_rate_ph
        description: "People_in_count converted to an hourly rate."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: utilization_5m
        description: "Utilization ratio (arrival_rate_ph / capacity_per_hour)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: pressure_index_5m
        description: "Composite pressure index based on utilization and queue length."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"


  - name: fct_mobility_od_15m
    description: "Mobility flows from origin zones to destination stores every 15 minutes, with gravity model score and weather context."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['origin_zone_id', 'dest_store_id', 'ts_15m']
    columns:
      - name: origin_zone_id
        description: "Origin zone of the flow (natural key from zones staging)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__zones')
                field: zone_id

      - name: dest_store_id
        description: "FK to dim_store (destination store)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_store')
                field: store_id

      - name: date_id
        description: "FK to dim_date (cast of ts_15m)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: date_id

      - name: ts_15m
        description: "15-minute timestamp of the observation."
        tests: [not_null]

      - name: arrivals
        description: "Number of arrivals from origin_zone to dest_store in that 15-minute slot."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: distance_km
        description: "Distance between zone centroid and store in km."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: gravity_score
        description: "Gravity-model potential for that OD pair at that time."

      - name: origin_population
        description: "Population of the origin zone (from zones staging)."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: dest_floor_area_m2
        description: "Floor area of the destination store in m2."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: dest_capacity_per_hour
        description: "Operational throughput capacity of the destination store."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: weather_bucket
        description: "Weather category for the origin zone on that day (MILD / HOT / COLD / LIGHT_RAIN / HEAVY_RAIN)."

      - name: is_rainy
        description: "1 if it is a rainy day in the origin zone, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"

      - name: is_hot
        description: "1 if it is a hot day in the origin zone, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"

      - name: is_cold
        description: "1 if it is a cold day in the origin zone, else 0."
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "in (0, 1)"
