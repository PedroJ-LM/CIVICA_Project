version: 2

models:

  # ======================
  # MAIN ENTITIES (now referencing catalog IDs)
  # ======================

  - name: stg_franchise_script__stores
    description: "Canonicalized stores; format/status normalized via IDs; consistent types and coords."
    columns:
    - name: store_id
      description: "Natural key of the store."
      tests: [not_null, unique]

    - name: zone_id
      description: "Zone foreign key."
      tests:
        - not_null
        - relationships:
            arguments:
              to: ref('stg_franchise_script__zones')
              field: zone_id

    - name: store_format_id
      description: "Catalog ID for store format."
      tests:
        - not_null
        - relationships:
            arguments:
              to: ref('stg_franchise_script__store_formats')
              field: store_format_id

    - name: store_status_id
      description: "Catalog ID for store status."
      tests:
        - not_null
        - relationships:
            arguments:
              to: ref('stg_franchise_script__store_status')
              field: store_status_id

    - name: opening_time
      description: "Opening time cast to TIME."
      tests: [not_null]

    - name: closing_time
      description: "Closing time cast to TIME."
      tests: [not_null]

    - name: capacity_per_hour
      description: "Operational throughput capacity; must be positive."
      tests:
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: floor_area_m2
      description: "Store floor area in square meters; must be positive."
      tests:
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: gate_count
      description: "Number of gates; must be >= 1."
      tests:
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 1"

    - name: lat
      description: "Latitude in decimal degrees."
      tests:
        - dbt_utils.expression_is_true:
            arguments:
              expression: "between -90 and 90"

    - name: lon
      description: "Longitude in decimal degrees."
      tests:
        - dbt_utils.expression_is_true:
            arguments:
              expression: "between -180 and 180"

    - name: date_load_utc
      description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
      tests: [not_null]

  - name: stg_franchise_script__zones
    description: "Canonicalized zones (types, coords) with cleaned names (without #n) and typed attributes."
    columns:
      - name: zone_id
        tests: [not_null, unique]
      - name: zone_name
        description: "Zone name cleaned (without the '#<n>' suffix), uppercased."
        tests:
          - not_null
      - name: lat
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -90 and 90"
      - name: lon
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -180 and 180"
      - name: population
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: income_index
      - name: unemployment_rate_pct
        description: "Unemployment in percent (0–100), renamed with _pct."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 100"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__store_gates
    description: "Canonicalized store gates; direction normalized to direction_id."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','gate_id']
    columns:
      - name: store_id
        description: "FK to store."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id
      - name: gate_id
        description: "Gate id; unique per store."
        tests:
          - not_null
      - name: gate_name
        description: "Human-readable name of the gate."
      - name: direction_id
        description: "Catalog ID for direction (IN/OUT)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__directions')
                field: direction_id
      - name: technology
        description: "Sensor technology identifier."
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__pos_store_days
    description: "Daily POS totals per store (DAY, STORE_ID) with canonical names."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','day']
    columns:
      - name: store_id
        description: "Store natural key."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id
      - name: day
        description: "Business day."
        tests: [not_null]
      - name: tickets_day
        description: "Tickets count (from TICKET_COUNT)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: gross_amount_day
        description: "Gross amount of day (from TOTAL_AMOUNT)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: avg_ticket
        description: "Average ticket amount (from AVG_TICKET_AMOUNT)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__zone_weather_days
    description: "Daily weather by zone; types cleaned; label normalized to weather_label_id."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['zone_id','day']
    columns:
      - name: zone_id
        description: "Zone natural key."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__zones')
                field: zone_id
      - name: day
        description: "Day of observation."
        tests: [not_null]
      - name: t_avg_c
        description: "Average temperature (°C) from TEMP_C."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -50 and 60"
      - name: rain_mm
        description: "Precipitation (mm) from RAINFALL_MM."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: wind_kmh
        description: "Wind speed (km/h)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: weather_label_id
        description: "Catalog ID for weather label."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__weather_labels')
                field: weather_label_id
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__entries_5m
    description: "5-minute entries per gate. Clean types and derived minute_5m_index."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','gate_id','ts_5m','direction_id']
    columns:
      - name: store_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id
      - name: gate_id
        tests: [not_null]
      - name: ts_5m
        tests: [not_null]
      - name: direction_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__directions')
                field: direction_id
      - name: people_count
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: minute_5m_index
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 287"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__iot_presence_5m
    description: "5-minute device presence per store. Derived minute_5m_index."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','ts_5m']
    columns:
      - name: store_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id
      - name: ts_5m
        tests: [not_null]
      - name: devices
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: minute_5m_index
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 287"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__queues_5m
    description: "5-minute queue metrics per store. Derived minute_5m_index."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','ts_5m']
    columns:
      - name: store_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id
      - name: ts_5m
        tests: [not_null]
      - name: queue_avg
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: wait_avg_s
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: minute_5m_index
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 287"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__mobility_od_15m
    description: "Mobility flows O→D every 15 minutes. Typed and time-derived."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['origin_zone_id','dest_store_id','ts_15m']
    columns:
      - name: origin_zone_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__zones')
                field: zone_id
      - name: dest_store_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id
      - name: ts_15m
        tests: [not_null]
      - name: arrivals
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: minute_15m_index
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 95"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__staff_shifts
    description: "Staff shifts per store; role normalized to role_id. Grain (staff_id, shift_start)."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['staff_id','shift_start']
    columns:
      - name: staff_id
        tests: [not_null]
      - name: store_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id
      - name: role_id
        description: "Catalog ID for staff role."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__staff_roles')
                field: role_id
      - name: shift_start
        tests: [not_null]
      - name: shift_end
        tests: [not_null]
      - name: register_id
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__inventory_days
    description: "Daily stock/sales/replenishments per store-product."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','product_id','day']
    columns:
      - name: store_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id
      - name: product_id
        tests: [not_null]
      - name: day
        tests: [not_null]
      - name: stock
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: units_sold
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: units_replenished
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__pos_tickets
    description: "POS tickets with typed fields, derived day/duration, and normalized channel/promo IDs."
    columns:
      - name: ticket_id
        tests: [not_null, unique]

      - name: store_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id

      - name: opened_at
        tests: [not_null]

      - name: closed_at
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= opened_at"   # closed_at >= opened_at

      - name: total_amount
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: channel_id
        description: "Catalog ID for sales channel."
        tests:
          - relationships:
              arguments:
                to: ref('stg_franchise_script__channels')
                field: channel_id

      - name: promo_code
        description: "Normalized promo code; 'NO_PROMO' when there was no promo in the source."
        tests:
          - not_null

      - name: promo_id
        description: "Catalog ID for promo code (includes NO_PROMO for tickets without promo)."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__promos')
                field: promo_id

      - name: day

      - name: duration_sec
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]


  # ======================
  # CATALOG STAGING (distinct normalized domains)
  # ======================

  - name: stg_franchise_script__store_formats
    description: "Catalog of store formats (distinct values with deterministic IDs)."
    columns:
      - name: store_format_id
        tests: [not_null, unique]
      - name: store_format_name
        tests: [not_null, unique]

  - name: stg_franchise_script__store_status
    description: "Catalog of store operational statuses."
    columns:
      - name: store_status_id
        tests: [not_null, unique]
      - name: store_status_name
        tests: [not_null, unique]

  - name: stg_franchise_script__staff_roles
    description: "Catalog of staff roles."
    columns:
      - name: role_id
        tests: [not_null, unique]
      - name: role_name
        tests: [not_null, unique]

  - name: stg_franchise_script__directions
    description: "Catalog of gate directions (IN/OUT)."
    columns:
      - name: direction_id
        tests: [not_null, unique]
      - name: direction_name
        tests: [not_null, unique]

  - name: stg_franchise_script__channels
    description: "Catalog of sales channels."
    columns:
      - name: channel_id
        tests: [not_null, unique]
      - name: channel_name
        tests: [not_null, unique]

  - name: stg_franchise_script__promos
    description: "Catalog of promo codes (distinct non-null codes, including NO_PROMO)."
    columns:
      - name: promo_id
        tests: [not_null, unique]
      - name: promo_code
        tests: [not_null, unique]

  - name: stg_franchise_script__weather_labels
    description: "Catalog of weather labels."
    columns:
      - name: weather_label_id
        tests: [not_null, unique]
      - name: weather_label
        tests: [not_null, unique]

  - name: stg_franchise_script__regions
    description: "Regions (comunidades autónomas) derived from the zones hierarchy seed."
    columns:
      - name: region_id
        description: "Surrogate key of the region (MD5 over region_name)."
        tests: [not_null, unique]

      - name: region_name
        description: "Nombre de la comunidad autónoma."
        tests: [not_null, unique]

      - name: country_id
        description: "FK to stg_franchise_script__countries."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__countries')
                field: country_id

  - name: stg_franchise_script__countries
    description: "Countries derived from the zones hierarchy seed."
    columns:
      - name: country_id
        description: "Surrogate key of the country (MD5 over country_name)."
        tests: [not_null, unique]

      - name: country_name
        description: "Country name (uppercased, normalized)."
        tests: [not_null, unique]

