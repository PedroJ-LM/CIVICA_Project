version: 2

models:
  - name: stg_franchise_script__stores
    description: "Canonicalized stores (consistent types, uppercased enums, time casting)."
    columns:
      - name: store_id
        description: "Natural key of the store."
        tests: [not_null, unique]

      - name: zone_id
        description: "Zone foreign key."
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__zones')
              field: zone_id

      - name: store_format
        description: "Normalized as uppercase."
        tests:
          - accepted_values:
              values: ['FLAGSHIP','MALL','STREET','OUTLET']

      - name: status
        description: "Store operational status."
        tests:
          - accepted_values:
              values: ['OPEN','REFURBISHMENT']

      - name: opening_time
        description: "Opening time casted to TIME."
        tests: [not_null]

      - name: closing_time
        description: "Closing time casted to TIME."
        tests: [not_null]

      - name: capacity_per_hour
        description: "Operational throughput capacity; must be positive."
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: floor_area_m2
        description: "Store floor area in square meters; must be positive."
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: gate_count
        description: "Number of gates; must be >= 1."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 1"

      - name: lat
        description: "Latitude in decimal degrees."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -90 and 90"

      - name: lon
        description: "Longitude in decimal degrees."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -180 and 180"

      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__zones
    description: "Canonicalized zones (types, coords). unemployment_rate_pct kept as 0–100."
    columns:
      - name: zone_id
        tests: [not_null, unique]
      - name: zone_name
      - name: lat
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -90 and 90"
      - name: lon
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -180 and 180"
      - name: population
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: income_index
      - name: unemployment_rate_pct
        description: "Unemployment in percent (0–100), renamed with _pct."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 100"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__store_gates
    description: "Canonicalized store gates (direction normalized, types set)."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','gate_id']
    columns:
      - name: store_id
        description: "FK to store."
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__stores')
              field: store_id
      - name: gate_id
        description: "Gate id; unique per store."
        tests:
          - not_null
      - name: gate_name
        description: "Human-readable name of the gate."
      - name: direction
        description: "IN or OUT."
        tests:
          - accepted_values:
              values: ['IN','OUT']
      - name: technology
        description: "Sensor technology identifier."
        # Preferimos no cerrar aquí los valores hasta observar el dataset real; lo validaremos más adelante.
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__pos_store_days
    description: "Daily POS totals per store (DAY, STORE_ID) con nombres canónicos."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','day']
    columns:
      - name: store_id
        description: "Store natural key."
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__stores')
              field: store_id
      - name: day
        description: "Business day."
        tests: [not_null]
      - name: tickets_day
        description: "Tickets count (from TICKET_COUNT)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: gross_amount_day
        description: "Gross amount of day (from TOTAL_AMOUNT)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: avg_ticket
        description: "Average ticket amount (from AVG_TICKET_AMOUNT)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__zone_weather_days
    description: "Daily weather by zone; TIPADO y labels normalizados."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['zone_id','day']
    columns:
      - name: zone_id
        description: "Zone natural key."
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__zones')
              field: zone_id
      - name: day
        description: "Day of observation."
        tests: [not_null]
      - name: t_avg_c
        description: "Average temperature (°C) from TEMP_C."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between -50 and 60"
      - name: rain_mm
        description: "Precipitation (mm) from RAINFALL_MM."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: wind_kmh
        description: "Wind speed (km/h)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: weather_label
        description: "Categorical weather label (UPPER)."
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__entries_5m
    description: "5-minute entries per gate. Clean types, IN/OUT, derived day & minute_5m_index."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','gate_id','ts_5m','direction']
    columns:
      - name: store_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__stores')
              field: store_id
      - name: gate_id
        tests: [not_null]
      - name: ts_5m
        tests: [not_null]
      - name: direction
        tests:
          - accepted_values:
              values: ['IN','OUT']
      - name: people_count
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: minute_5m_index
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 287"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__iot_presence_5m
    description: "5-minute device presence per store. Derived day & minute_5m_index."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','ts_5m']
    columns:
      - name: store_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__stores')
              field: store_id
      - name: ts_5m
        tests: [not_null]
      - name: devices
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: minute_5m_index
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 287"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__queues_5m
    description: "5-minute queue metrics per store. Derived day & minute_5m_index."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','ts_5m']
    columns:
      - name: store_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__stores')
              field: store_id
      - name: ts_5m
        tests: [not_null]
      - name: queue_avg
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: wait_avg_s
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: minute_5m_index
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 287"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__mobility_od_15m
    description: "Mobility flows O→D cada 15 min. Tipado y derivadas de tiempo."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['origin_zone_id','dest_store_id','ts_15m']
    columns:
      - name: origin_zone_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__zones')
              field: zone_id
      - name: dest_store_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__stores')
              field: store_id
      - name: ts_15m
        tests: [not_null]
      - name: arrivals
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: minute_15m_index
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 95"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__staff_shifts
    description: "Turnos de personal por tienda; roles en UPPER. Grano (staff_id, shift_start)."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['staff_id','shift_start']
    columns:
      - name: staff_id
        tests: [not_null]
      - name: store_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__stores')
              field: store_id
      - name: role
      - name: shift_start
        tests: [not_null]
      - name: shift_end
        tests: [not_null]
      - name: register_id
      - name: day
        tests: [not_null]
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__inventory_days
    description: "Stock/ventas/reposiciones diarias por tienda-producto."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['store_id','product_id','day']
    columns:
      - name: store_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_franchise_script__stores')
              field: store_id
      - name: product_id
        tests: [not_null]
      - name: day
        tests: [not_null]
      - name: stock
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: units_sold
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: units_replenished
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]

  - name: stg_franchise_script__pos_tickets
    description: "Tickets POS con tipado y derivadas simples (day, duration_sec)."
    columns:
      - name: ticket_id
        tests: [not_null, unique]
      - name: store_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_franchise_script__stores')
                field: store_id
      - name: opened_at
        tests: [not_null]
      - name: closed_at
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= opened_at"   # closed_at >= opened_at
      - name: total_amount
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: day
      - name: duration_sec
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: date_load_utc
        description: "UTC load timestamp derived from _FIVETRAN_SYNCED."
        tests: [not_null]
